version: '3.8'

# Gravitate-Health FOSPS Development Environment
# A local deployment of the Federated Open Source Platform and Services
# for developing Lenses and Preprocessors (pluggable components of the focusing mechanism)

services:
  # ============================================================================
  # CORE FOCUSING SERVICES
  # ============================================================================

  # Focusing Manager - Central orchestration service that coordinates
  # between preprocessors and lens selectors
  focusing-manager:
    container_name: focusing-manager
    image: ghcr.io/gravitate-health/focuing-manager:latest
    environment:
      # Configuration for the focusing manager
      ENVIRONMENT: standalone
      PREPROCESSING_LABEL_SELECTOR: eu.gravitate-health.fosps.preprocessing=true
      FOCUSING_LABEL_SELECTOR: eu.gravitate-health.fosps.focusing=true
      FHIR_IPS_URL:
      FHIR_EPI_URL:
      PROFILE_URL:
    networks:
      - focusing-network
    depends_on:
      - fhir-emulator
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    restart: unless-stopped

  # ============================================================================
  # FHIR DATA SERVICES
  # ============================================================================

  # FHIR Emulator - Provides FHIR API endpoints with data from Patients and ePIs folders
  fhir-emulator:
    container_name: fhir-emulator
    image: ghcr.io/gravitate-health/fhir-emulator:latest
    environment:
      NODE_ENV: development
      LOG_LEVEL: INFO
      FILES_DIR: /data
    networks:
      - focusing-network
    volumes:
      # Mount local FHIR data folders
      - ./Patients:/data/Patient:ro
      - ./ePIs:/data/Bundle:ro
    restart: unless-stopped

  # ============================================================================
  # Terminology SERVICE
  # ============================================================================

  # Terminology Server - Provides FHIR Terminology services (CodeSystem, ValueSet, etc.)
  terminology-server:
    container_name: terminology-server
    image: ghcr.io/gravitate-health/terminology-server:latest
    networks:
      - focusing-network
    restart: unless-stopped


  # ============================================================================
  # PREPROCESSOR SERVICES
  # Preprocessors are pluggable components that transform/enrich FHIR data
  # They use labels for automatic discovery by the focusing manager
  # ============================================================================

  # MVP2 Preprocessor - Production-grade preprocessor implementation
  # Labels identify this service to the focusing manager
  mvp2-preprocessor:
    container_name: mvp2-preprocessor
    image: ghcr.io/gravitate-health/preprocessing-service-mvp2:latest
    environment:
      ENVIRONMENT: dev
      TERM_SERVER_URL: http://terminology-server:3000
    networks:
      - focusing-network
    depends_on:
      - terminology-server
    restart: unless-stopped
    # Service discovery labels - used by focusing manager to detect this preprocessor
    labels:
      eu.gravitate-health.fosps.preprocessing: true

  # Preprocessor example - Use as a template for building custom preprocessors
  # Labels identify this service to the focusing manager
  # my-preprocessor:
  #   container_name: my-preprocessor
  #   image: <your-custom-preprocessor-image>
  #   environment:
  #     ENVIRONMENT: dev
  #   networks:
  #     - focusing-network
  #   restart: unless-stopped
  #   # Service discovery labels - used by focusing manager to detect this preprocessor
  #   labels:
  #     eu.gravitate-health.fosps.preprocessing: true

  # ============================================================================
  # LENS SELECTOR SERVICES
  # Lens selectos discover and expose FHIR Library components (Lenses)
  # They use labels for automatic discovery by the focusing manager
  # ============================================================================

  # Folder-Based Lens selector - Discovers lenses from the local Lenses folder
  lens-selector-file:
     container_name: lens-selector-file
     image: ghcr.io/gravitate-health/lens-selector-file:latest
     environment:
        NODE_ENV: development
     networks:
       - focusing-network
     volumes:
      # Mount local lenses folder, but you can modify to point to your development environment
       - ./Lenses:/data/lenses:ro
     restart: unless-stopped
     # Service discovery labels - used by focusing manager to detect this selector
     labels:
       eu.gravitate-health.fosps.focusing: true

  # Git-Based Lens Selectors
  # Uncomment and configure to enable
  # NOTE: Configure as needed for your specific lens repositories, comment out or delete if not needed
  conditions-git-lens-selector:
    container_name: conditions-git-lens-selector
    image: ghcr.io/gravitate-health/lens-selector-git:latest
    environment:
      # you can modify these variables to point to your development lens repository
      GIT_REPO_URL: https://github.com/Gravitate-Health/conditions-lens.git
      GIT_BRANCH: main
      CACHE_TTL_MINUTES: 10 # lower this if repo is actively developing lenses
    networks:
      - focusing-network
    restart: unless-stopped
    labels:
       eu.gravitate-health.fosps.focusing: true

  pregnancy-git-lens-selector:
    container_name: pregnancy-git-lens-selector
    image: ghcr.io/gravitate-health/lens-selector-git:latest
    environment:
      GIT_REPO_URL: https://github.com/Gravitate-Health/pregnancy-lens.git
      CACHE_TTL_MINUTES: 10 
    networks:
      - focusing-network
    restart: unless-stopped
    labels:
      eu.gravitate-health.fosps.focusing: true


  # ============================================================================
  # TESTING & INSPECTION SERVICES
  # ============================================================================

  # Focusing Inspector - Web UI for testing and validating the focusing process
  # Provides interactive testing interface for developers
  focusing-inspector:
    container_name: focusing-inspector
    image: ghcr.io/gravitate-health/focusing-inspector:latest
    ports:
      - "4200:3000"
    environment:
      ENVIRONMENT: dev
      BACKEND_ENDPOINT: http://localhost:8080
    networks:
      - focusing-network
    depends_on:
      - nginx-proxy
    restart: unless-stopped

  # Swagger UI - API documentation and testing interface
  # Exposes the focusing manager's OpenAPI specification
  # TODO: overide servers to point to localhost
  swagger-ui:
    container_name: swagger-ui
    image: swaggerapi/swagger-ui:latest
    ports:
      - "8888:8080"
    environment:
      URLS: "[{\"url\": \"https://raw.githubusercontent.com/Gravitate-Health/focusing-manager/main/openapi.yaml\", \"name\": \"Focusing Manager API\"}]"
      SWAGGERUI_DOCEXPANSION: list
      SWAGGERUI_DEFAULT_MODELS_EXPAND_DEPTH: 1
    networks:
      - focusing-network
    depends_on:
      - focusing-manager
    restart: unless-stopped

# ============================================================================
# REVERSE PROXY SERVICE
# ============================================================================
# Uses nginx to route external requests to internal services
# No need to modify this unless you want custom routing rules
  nginx-proxy:
    container_name: nginx-proxy
    image: nginx:alpine
    ports:
      - "8080:80"
    networks:
      - focusing-network
    depends_on:
      - focusing-manager
      - fhir-emulator
    restart: unless-stopped
    volumes:
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro

networks:
  focusing-network:
    driver: bridge
    name: focusing-network

# ============================================================================
# NOTES FOR DEVELOPERS
# ============================================================================
#
# ADDING A NEW LENS SELECTOR:
# 1. copy-and-paste the lens-selector-git and/or lens-selector-file sections
# 2. Update the service name, container_name, GIT_REPOSITORY_URL, and other varuiables pointing to your development lens repository
# 3. Run: docker-compose up -d <service name>
#
# REMOVING A SERVICE:
# Simply comment out the service section or delete it, then run:
#   docker-compose up -d
#
# VIEWING LOGS:
# docker-compose logs -f <service-name>
# Example: docker-compose logs -f focusing-manager
#
# REBUILDING IMAGES:
# docker-compose build --no-cache
#
# RESETTING EVERYTHING:
# docker-compose down -v  # Removes containers and volumes
#
# SERVICE DISCOVERY:
# The focusing manager automatically discovers services using container labels:
# - Preprocessors: eu.gravitate-health.fosps.preprocessing=true
# - Lens Selectors: eu.gravitate-health.fosps.focusing=true
#
# ACCESSING SERVICES FROM HOST:
# - Focusing Manager API: http://localhost:8080/focusing
# - Focusing Inspector: http://localhost:4200
# - Swagger UI: http://localhost:8888
# - Services within network: http://<service-name>:<port>
#
# ============================================================================
