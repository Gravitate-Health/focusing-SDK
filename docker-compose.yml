# Gravitate-Health FOSPS Development Environment
# A local deployment of the Federated Open Source Platform and Services
# for developing Lenses and Preprocessors (pluggable components of the focusing mechanism)

services:
  # ============================================================================
  # CORE FOCUSING SERVICES
  # ============================================================================

  # Focusing Manager - Central orchestration service that coordinates
  # between preprocessors and lens selectors
  focusing-manager:
    container_name: focusing-manager
    image: ghcr.io/gravitate-health/focusing-manager:latest
    environment:
      # Configuration for the focusing manager
      ENVIRONMENT: standalone
      PREPROCESSING_LABEL_SELECTOR: eu.gravitate-health.fosps.preprocessing=True
      FOCUSING_LABEL_SELECTOR: eu.gravitate-health.fosps.focusing=True
      FHIR_IPS_URL: http://fhir-emulator:5000/fhir
      FHIR_EPI_URL: http://fhir-emulator:5000/fhir
      PROFILE_URL: http://fhir-emulator:5000/fhir
    networks:
      - focusing-network
    depends_on:
      - fhir-emulator
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    restart: unless-stopped

  # ============================================================================
  # FHIR DATA SERVICES
  # ============================================================================

  # FHIR Emulator - Provides FHIR API endpoints with data from Patients and ePIs folders
  fhir-emulator:
    container_name: fhir-emulator
    image: ghcr.io/gravitate-health/fhir-emulator:latest
    environment:
      NODE_ENV: development
      LOG_LEVEL: INFO
      FILES_DIR: /data
    networks:
      - focusing-network
    volumes:
      # Mount local FHIR data folders
      - ./Patients:/data/Patient:ro
      - ./ePIs:/data/Bundle:ro
    restart: unless-stopped

  # ============================================================================
  # Terminology SERVICE
  # ============================================================================

  # Terminology service - Provides FHIR Terminology services (CodeSystem, ValueSet, etc.)
  terminology-service:
    container_name: terminology-service
    image: ghcr.io/gravitate-health/terminology-service:latest
    networks:
      - focusing-network
    restart: unless-stopped


  # ============================================================================
  # PREPROCESSOR SERVICES
  # Preprocessors are pluggable components that transform/enrich FHIR data
  # They use labels for automatic discovery by the focusing manager
  # ============================================================================

  # Terminology Preprocessor - Production-grade preprocessor implementation
  # Labels identify this service to the focusing manager
  terminology-preprocessor:
    container_name: terminology-preprocessor
    image: ghcr.io/gravitate-health/preprocessing-service-mvp2:latest
    environment:
      ENVIRONMENT: dev
      TERM_SERVER_URL: http://terminology-service:3000
      LOG_LEVEL: INFO
    networks:
      - focusing-network
    depends_on:
      - terminology-service
    restart: unless-stopped
    # Service discovery labels - used by focusing manager to detect this preprocessor
    labels:
      eu.gravitate-health.fosps.preprocessing: True


  clean-preprocessor:
    container_name: clean-preprocessor
    image: ghcr.io/gravitate-health/preprocessing-service-cleaner:main
    networks:
      - focusing-network
    restart: unless-stopped
    labels:
      eu.gravitate-health.fosps.preprocessing: True

  # Preprocessor example - Use as a template for building custom preprocessors
  # Labels identify this service to the focusing manager
  # my-preprocessor:
  #   container_name: my-preprocessor
  #   image: <your-custom-preprocessor-image>
  #   environment:
  #     ENVIRONMENT: dev
  #   networks:
  #     - focusing-network
  #   restart: unless-stopped
  #   # Service discovery labels - used by focusing manager to detect this preprocessor
  #   labels:
  #     eu.gravitate-health.fosps.preprocessing: True

  # ============================================================================
  # LENS SELECTOR SERVICES
  # Lens selectos discover and expose FHIR Library components (Lenses)
  # They use labels for automatic discovery by the focusing manager
  # ============================================================================

  # Folder-Based Lens selector - Discovers lenses from the local Lenses folder
  lens-selector-file:
     container_name: lens-selector-file
     image: ghcr.io/gravitate-health/lens-selector-file:latest
     environment:
        NODE_ENV: development
     networks:
       - focusing-network
     volumes:
      # Mount local lenses folder, but you can modify to point to your development environment
       - ./Lenses:/app/lenses:ro
     restart: unless-stopped
     # Service discovery labels - used by focusing manager to detect this selector
     labels:
       eu.gravitate-health.fosps.focusing: True

  # Git-Based Lens Selectors
  # Uncomment and configure to enable
  # NOTE: Configure as needed for your specific lens repositories, comment out or delete if not needed
  conditions-git-lens-selector:
    container_name: conditions-git-lens-selector
    image: ghcr.io/gravitate-health/lens-selector-git:latest
    environment:
      # you can modify these variables to point to your development lens repository
      GIT_REPO_URL: https://github.com/Gravitate-Health/conditions-lens.git
      GIT_BRANCH: main
      CACHE_TTL_MINUTES: 10 # lower this if repo is actively developing lenses
    networks:
      - focusing-network
    restart: unless-stopped
    labels:
       eu.gravitate-health.fosps.focusing: True

  questionnaire-git-lens-selector:
    container_name: questionnaire-git-lens-selector
    image: ghcr.io/gravitate-health/lens-selector-git:latest
    environment:
      GIT_REPO_URL: https://github.com/joofio/gh-questionnaire-lens.git
      GIT_BRANCH: main
      CACHE_TTL_MINUTES: 10 
    networks:
      - focusing-network
    restart: unless-stopped
    labels:
      eu.gravitate-health.fosps.focusing: True


  # ============================================================================
  # TESTING & INSPECTION SERVICES
  # ============================================================================

  # Dozzle - Real-time Docker log viewer
  # Provides a web UI to view logs from all containers
  # Accessible at http://localhost:8080/logs/ via the proxy (Caddy)
  dozzle:
    container_name: dozzle
    image: amir20/dozzle:latest
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - focusing-network
    restart: unless-stopped
    environment:
      DOZZLE_LEVEL: info
      DOZZLE_FILTER: "name=focusing-*,name=fhir-*,name=mvp2-*,name=clean-*,name=lens-*,name=terminology-*"
      DOZZLE_BASE: /logs

  # Focusing Inspector - Web UI for testing and validating the focusing process
  # Provides interactive testing interface for developers
  # Accessible at http://localhost:8080/inspector/ via the proxy (Caddy)
  focusing-inspector:
    container_name: focusing-inspector
    image: ghcr.io/gravitate-health/focusing-inspector:latest
    environment:
      ENVIRONMENT: dev
      BACKEND_ENDPOINT: http://localhost:8080
      BASE_HREF: /inspector/
    networks:
      - focusing-network
    depends_on:
      - caddy
    restart: unless-stopped

  # Swagger UI - API documentation and testing interface
  # Exposes the focusing manager's OpenAPI specification from local openapi.yaml
  # Accessible at http://localhost:8080/swagger/ via the proxy (Caddy)
  swagger-ui:
    container_name: swagger-ui
    image: swaggerapi/swagger-ui:latest
    environment:
      # Use local openapi.yaml mounted to /openapi.yaml
      URL: ./openapi.yaml
      SWAGGERUI_DOCEXPANSION: list
      SWAGGERUI_DEFAULT_MODELS_EXPAND_DEPTH: 1
    volumes:
      - ./openapi.yaml:/usr/share/nginx/html/openapi.yaml:ro
    networks:
      - focusing-network
    depends_on:
      - focusing-manager
    restart: unless-stopped

# ============================================================================
# REVERSE PROXY SERVICE
# ============================================================================
# Using Caddy as the reverse proxy to route external requests to internal services
# Exposes all web interfaces on a single port (8080) with path-based routing
# Paths:
#   - /focusing/     -> Focusing Manager API
#   - /inspector/    -> Focusing Inspector UI
#   - /swagger/      -> Swagger API Documentation
#   - /logs/         -> Dozzle Log Viewer
#   - /              -> Landing page (index.html)
  caddy:
    container_name: caddy
    image: caddy:2-alpine
    ports:
    # change this if 8080 is not possible
      - "8080:80"
    networks:
      - focusing-network
    depends_on:
      - focusing-manager
      - fhir-emulator
      - code-server
    restart: unless-stopped
    volumes:
      - ./web_proxy/Caddyfile:/etc/caddy/Caddyfile:ro
      - ./web_proxy/index.html:/usr/share/caddy/index.html:ro
      - ./web_proxy/style.css:/usr/share/caddy/style.css:ro

  # ============================================================================
  # Web-based IDE (code-server)
  # Accessible at http://localhost:8080/code/
  code-server:
    container_name: code-server
    build:
      context: ./tools/code-server
    networks:
      - focusing-network
    environment:
      # Set host UID/GID for linuxserver image file ownership (adjust if needed)
      PUID: 1000
      PGID: 1000
    volumes:
      # Ensure FHIR data folders are directly available in the workspace
      - ./ePIs:/config/workspace/ePIs
      - ./Patients:/config/workspace/Patients
      - ./Lenses:/config/workspace/Lenses
      # Persist code-server configuration across rebuilds
      - ./tools/code-server/config:/config
    restart: unless-stopped

networks:
  focusing-network:
    driver: bridge
    name: focusing-network

# ============================================================================
# NOTES FOR DEVELOPERS
# ============================================================================
#
# ADDING A NEW LENS SELECTOR:
# 1. copy-and-paste the lens-selector-git and/or lens-selector-file sections
# 2. Update the service name, container_name, GIT_REPOSITORY_URL, and other varuiables pointing to your development lens repository
# 3. Run: docker-compose up -d <service name>
#
# REMOVING A SERVICE:
# Simply comment out the service section or delete it, then run:
#   docker-compose up -d
#
# VIEWING LOGS:
# Web UI (Recommended): http://localhost:8080/logs/ - Real-time log viewer with search/filter
# Command Line:
#   docker-compose logs -f <service-name>
#   Example: docker-compose logs -f focusing-manager
#
# REBUILDING IMAGES:
# docker-compose build --no-cache
#
# RESETTING EVERYTHING:
# docker-compose down -v  # Removes containers and volumes
#
# SERVICE DISCOVERY:
# The focusing manager automatically discovers services using container labels:
# - Preprocessors: eu.gravitate-health.fosps.preprocessing=True
# - Lens Selectors: eu.gravitate-health.fosps.focusing=True
#
# ACCESSING SERVICES FROM HOST (single proxy port 8080):
# - Focusing Manager API: http://localhost:8080/focusing
# - Focusing Inspector: http://localhost:8080/inspector/
# - Swagger UI: http://localhost:8080/swagger/
# - Dozzle (Log Viewer): http://localhost:8080/logs/
# - Services within network: http://<service-name>:<port>
#
# ============================================================================
