upstream focusing_manager {
  server focusing-manager:3000;
}

upstream fhir_emulator {
  server fhir-emulator:5000;
}

server {
  listen 80;
  server_name _;

  # Focused API prefix -> focusing manager (strips /focusing/ before proxying)
  location /focusing/ {
    # proxy_pass with trailing slash strips the matching prefix (/focusing/) when forwarding
    proxy_pass http://focusing_manager/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  # Map /epi/* to the FHIR emulator and preserve the full incoming path
  # e.g. /epi/api/fhir/Bundle -> forwarded as /epi/api/fhir/Bundle
  location ^~ /epi/ {
    proxy_pass http://fhir_emulator$request_uri;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  # Map /ips/* to the FHIR emulator and preserve the full incoming path
  location ^~ /ips/ {
    proxy_pass http://fhir_emulator$request_uri;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  location / {
    return 404;
  }
}
